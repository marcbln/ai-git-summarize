# Implementation Plan - Fix Git Commit Message Formatting

This plan addresses the issue where multi-line commit messages generated by the AI are missing the required blank line between the subject (header) and the body. We will implement a "Belt and Suspenders" solution: enforcing the rule programmatically in Python while also updating the LLM prompts to request the correct format explicitly.

## Phase 1: Test-Driven Development (Reproduction & Verification)

We will start by creating a test case that simulates an AI response missing the newline. This ensures our programmatic fix works as expected.

- [ ] **Step 1: Create a new test file or update existing tests**
    - **Target:** `tests/test_ai_summarizer.py`
    - **Action:** Add a new test function `test_summarize_changes_forces_newline`.
    - **Logic:**
        1.  Mock the OpenAI client to return a malformed commit message: `feat: subject\n- body line 1`.
        2.  Call `summarizer.summarize_changes`.
        3.  Assert that the returned string is formatted correctly: `feat: subject\n\n- body line 1`.

## Phase 2: Programmatic Enforcement (The "Belt")

We will modify the summarizer logic to inspect the string returned by the AI. If a multi-line message is detected where the second line is not empty, we will inject a blank line.

- [ ] **Step 2: Implement formatting logic in `AISummarizer`**
    - **Target:** `ai_git/ai_summarizer.py`
    - **Method:** `summarize_changes`
    - **Action:**
        1.  Locate the section where `clean_summary` is obtained from `self._strip_backticks(summary)`.
        2.  Add logic to split the summary by lines.
        3.  Check if `len(lines) > 1` AND `lines[1].strip() != ""`.
        4.  If true, insert an empty string at index 1 (`lines.insert(1, "")`).
        5.  Rejoin the lines.
    - **Code Snippet Reference:**
      ```python
      if clean_summary:
          lines = clean_summary.splitlines()
          if len(lines) > 1 and lines[1].strip():
              print("[yellow]Adjusting format: Inserting missing blank line after subject.[/yellow]")
              lines.insert(1, "")
              clean_summary = "\n".join(lines)
      ```

## Phase 3: Prompt Engineering (The "Suspenders")

We will update the system prompts to explicitly instruct the LLM to adhere to the standard git commit format. This reduces the reliance on the programmatic fix and produces higher-quality initial outputs.

- [ ] **Step 3: Update `build_diff_prompt` (Detailed Strategy)**
    - **Target:** `ai_git/prompts.py`
    - **Action:** Update the system content string.
    - **Instruction:** Change "After the summary, provide a detailed explanation" to "After the summary line, YOU MUST LEAVE ONE EMPTY LINE, and then provide a detailed explanation".

- [ ] **Step 4: Update `build_unified_prompt` (AI Strategy)**
    - **Target:** `ai_git/prompts.py`
    - **Action:** Update the system content string under "3. Format".
    - **Instruction:** Change the DETAILED format description to: `DETAILED: "type: description", followed by ONE BLANK LINE, followed by bullet points.`

- [ ] **Step 5: Update `build_ai_decides_prompt` (Legacy/Generic Strategy)**
    - **Target:** `ai_git/prompts.py`
    - **Action:** Update item #3 or #4 in the system prompt to explicitly mention the blank line requirement.

## Phase 4: Verification

- [ ] **Step 6: Run Tests**
    - **Command:** `uv run pytest tests/test_ai_summarizer.py`
    - **Success Criteria:** The new test from Phase 1 must pass. Existing tests (backtick stripping, retries) must still pass.

- [ ] **Step 7: Manual Verification (Optional/Dry Run)**
    - **Command:** `ai-git --dry-run` (if supported for prompt inspection) or generate a commit on a dummy change.
    - **Check:** Ensure the printed output contains the empty line.


